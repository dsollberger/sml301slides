---
title: "21: RAG"
author: "Derek Sollberger"
date: "2025-11-19"
format:
  html:
    toc: true
---


# 21: Retrieval Augmentation Generation

## Learning Objectives

:::: {.columns}

::: {.column width="45%"}
- few-shot prompting
- chain-of-thought
- intro retrieval augmented generation
:::

::: {.column width="10%"}

:::

::: {.column width="45%"}
![RAG applications](Applications-of-Retrieval-Augmented-Generation.png)

* image source: [SoluLab](https://www.solulab.com/what-is-retrieval-augmented-generation/)

:::

::::


# Token Cost

::: {.callout-note}
## Tokens

"**Tokens** are words, character sets, or combinations of words and punctuation that are generated by large language models (LLMs) when they decompose text. Tokenization is the first step in training. The LLM analyzes the semantic relationships between tokens, such as how commonly they're used together or whether they're used in similar contexts. After training, the LLM uses those patterns and relationships to generate a sequence of output tokens based on the input sequence."
---[Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/ai/conceptual/understanding-tokens)
:::

## Tokenization

![tokenization](tokenization_examples.png)

* app: [TikTokenizer](https://tiktokenizer.vercel.app/)

## Cost Comparison

![comparing the major LLMs](gpt_claude2_pricing2.png)

* image source: [Merlin Tech](https://www.merlin.tech/llm-costs/), August 28, 2023

## Economies of Scale

![token cost over time](token_cost_over_time.png)

* image source: [Marginal Revolution](https://marginalrevolution.com/marginalrevolution/2024/08/the-falling-cost-of-tokens.html), August 25, 2024

## Prompt Complexity versus Cost

![fine tuning and costs](fine_tuning_cost.png)

* image source: [Mary Schwaber](https://medium.com/@mary.schwaber/few-shot-prompting-vs-fine-tuning-a-cost-efficiency-perspective-5bf00257c3e8)

::: {.callout-warning}
## DCP1
:::

# Prompt Augmentation

## In-Context Learning

![in-context learning](In_context_learning.png)

* image source: [PromptHub](https://www.prompthub.us/blog/in-context-learning-guide)

## Chain Prompting

![chain prompting](prompt-chaining-example.png)

* image source: [Gadesha and Kavlakoglu](https://www.ibm.com/think/topics/prompt-chaining)

## Chain of Thought

![chain of thought](chain_of_thought.png)

* image source: [Wei et al](https://arxiv.org/abs/2201.11903)

## Tree of Thought

![tree of thought](tree_of_thought.png)

* image source: [Technische Hochschule Augsburg](https://www.tha.de/en/Types-of-prompting.html)

::: {.callout-warning}
## DCP2
:::

# Data Ethics: Social Engineering

::::: {.panel-tabset}

## games

![Whispers from the Star](Whispers_splash.png)

* video game
* released August 14, 2025

## immersive

![voice communication with AI](Whispers_dialogue.png)

"We can video call, voice message, or text, and it's all powered by AI-driven dialogue. Right now, you’re the only one I’ve got."

## controversy

![asking personal questions](Whispers_meme.png)

* reviewers noted how AI-powered conversations were [co-created with human actors](https://www.notebookcheck.net/Steam-launch-New-interactive-fiction-game-debuts-to-Very-Positive-reviews-may-divide-gamers-over-heavy-AI-integration.1087821.0.html)
* some [gamers](https://youtu.be/ddbXNHTsKCs?si=HAqjLa7wb8Z5elC0&t=5910) claimed that there was [data harvesting](https://steamcommunity.com/app/3730100/discussions/0/595158249006738933/)
* producers did revise their [privacy policy](https://www.anuttacon.com/legal/privacy/)

## obituaries

![preserving dead relatives](cheap-ai-clones-dead-relatives.png)

* image source: [Futurism](https://futurism.com/the-byte/cheap-ai-clones-dead-relatives)

## scams

![using dead relatives](ai-obit-scams.png)

* image source: [Blackbird AI](https://blackbird.ai/blog/ai-powered-obituary-scams-targeted-phishing/)

:::::


::: {.callout-warning}
## DCP3
:::


# Retrieval Augmented Generation

::: {.callout-note}
## RAG

"**Retrieval-Augmented Generation** (RAG) is the process of optimizing the output of a large language model, so it references an authoritative knowledge base outside of its training data sources before generating a response. Large Language Models (LLMs) are trained on vast volumes of data and use billions of parameters to generate original output for tasks like answering questions, translating languages, and completing sentences. RAG extends the already powerful capabilities of LLMs to specific domains or an organization's internal knowledge base, all without the need to retrain the model. It is a cost-effective approach to improving LLM output so it remains relevant, accurate, and useful in various contexts." --- [AWS](https://aws.amazon.com/what-is/retrieval-augmented-generation/)
:::

::: {.callout-tip}
## RAG

Informally, it is said that **Retrieval-Augmented Generation** (RAG) allows users to have an LLM assist in reading a PDF.
:::

## Example: Film Review

We will look at an example from [Chapter 8](https://github.com/HandsOnLLM/Hands-On-Large-Language-Models?tab=readme-ov-file) of *Hands-On Large Language Models by Jay Alammar and Maarten Grootenhorst

:::: {.columns}

::: {.column width="30%"}
![Interstellar](Interstellar_movie_poster.png)

* image source: [Posterazzi](https://www.posterazzi.com/interstellar-movie-poster-print-27-x-40-item-movab14245/)
:::

::: {.column width="10%"}
	
:::

::: {.column width="60%"}
> Interstellar is a 2014 epic science fiction film co-written, directed, and produced by Christopher Nolan.
It stars Matthew McConaughey, Anne Hathaway, Jessica Chastain, Bill Irwin, Ellen Burstyn, Matt Damon, and Michael Caine.
Set in a dystopian future where humanity is struggling to survive, the film follows a group of astronauts who travel through a wormhole near Saturn in search of a new home for mankind.
Brothers Christopher and Jonathan Nolan wrote the screenplay, which had its origins in a script Jonathan developed in 2007.
Caltech theoretical physicist and 2017 Nobel laureate in Physics[4] Kip Thorne was an executive producer, acted as a scientific consultant, and wrote a tie-in book, The Science of Interstellar.
Cinematographer Hoyte van Hoytema shot it on 35 mm movie film in the Panavision anamorphic format and IMAX 70 mm.
Principal photography began in late 2013 and took place in Alberta, Iceland, and Los Angeles.
Interstellar uses extensive practical and miniature effects and the company Double Negative created additional digital effects.
Interstellar premiered on October 26, 2014, in Los Angeles.
In the United States, it was first released on film stock, expanding to venues using digital projectors.
The film had a worldwide gross over $677 million (and $773 million with subsequent re-releases), making it the tenth-highest grossing film of 2014.
It received acclaim for its performances, direction, screenplay, musical score, visual effects, ambition, themes, and emotional weight.
It has also received praise from many astronomers for its scientific accuracy and portrayal of theoretical astrophysics. Since its premiere, Interstellar gained a cult following,[5] and now is regarded by many sci-fi experts as one of the best science-fiction films of all time.
Interstellar was nominated for five awards at the 87th Academy Awards, winning Best Visual Effects, and received numerous other accolades

--- [Wikipedia](https://en.wikipedia.org/wiki/Interstellar_(film))
:::

::::

Experiment: 

* treat each sentence as a separate *document* as part of a *corpus*
* build search database with `faiss`
* **rerank** with [BM25](https://en.wikipedia.org/wiki/Okapi_BM25) search algorithm




# Quo Vadimus?

:::: {.columns}

::: {.column width="60%"}
* due this Friday (Nov 21):

    - **Precept 10** (2 hours)
    - surveys:
        - **Participant Informed Consent** (5 minutes)
        - **Research Consent** (5 minutes)
    - group work:
        - **Abstract (draft)** (30 minutes)

:::

::: {.column width="10%"}
	
:::

::: {.column width="30%"}

Our SML 301 lecture session for **Monday, November 24** will be remote (Zoom).

* guest speaker from AI industry

:::

::::


# Footnotes

::: {.callout-note collapse="true"}

## (optional) Additional Resources and References

* [LLM strategies](https://towardsdatascience.com/decoding-strategies-in-large-language-models-9733a8f70539/)
* [Prompting Guide](https://www.promptingguide.ai/techniques)

:::

::: {.callout-note collapse="true"}
## Session Info

```{r}
sessionInfo()
```
:::


:::: {.columns}

::: {.column width="45%"}
	
:::

::: {.column width="10%"}
	
:::

::: {.column width="45%"}

:::

::::

::::: {.panel-tabset}



:::::